graph TB
    subgraph "MCP Host Environment"
        subgraph "GitHub Copilot (Host)"
            GC[GitHub Copilot Chat]
            LM[Language Model]
            HOST[Host - Requests Actions<br/>Interacts with Users]
        end
        
        subgraph "VS Code Core"
            ED[Active Editor]
            CFG[Configuration]
            UI[User Interface]
        end
    end
    
    subgraph "MCP Client Layer"
        subgraph "MCP Client Plugin"
            CP[CopilotMCPChatParticipant]
            BCP[BitBucketCodeProvider]
            MC[MCP Client<br/>Connects to servers<br/>Manages protocol]
        end
    end
    
    subgraph "MCP Protocol"
        PROTO[JSON-RPC 2.0<br/>MCP Standard Protocol]
    end
    
    subgraph "Spring AI MCP Server"
        subgraph "MCP Server Core"
            SERVER[MCP Server<br/>Exposes tools/resources<br/>Connects to data/services]
            TOOLS[Tools Handler]
            RESOURCES[Resources Handler]
        end
        
        subgraph "Spring AI Enhancement Layer"
            AI[AI Service]
            EMB[Embeddings Engine]
            VEC[Vector Store]
            CONTEXT[Context Builder]
        end
    end
    
    subgraph "Local Data Sources"
        CACHE[Repository Cache]
        INDEX[Code Index]
        CONFIG[Server Config]
        LOGS[Access Logs]
    end
    
    subgraph "Remote Services"
        subgraph "BitBucket Cloud API"
            BB_API[BitBucket REST API]
            WS[Workspace API]
            REPOS[Repository API]
            FILES[Source API]
            SEARCH_API[Search API]
        end
        
        subgraph "External Services"
            AUTH[OAuth Service]
            WEBHOOK[Webhook Handler]
        end
    end
    
    %% User Interactions
    User -->|Types @bitbucket-mcp query| GC
    UI -->|Shows responses| User
    
    %% Host Layer
    HOST -->|Requests actions| MC
    GC -->|Chat request| CP
    CP -->|Enhanced context + prompt| LM
    LM -->|AI-powered response| GC
    
    %% Client Layer
    CP -->|Get repository context| BCP
    BCP -->|MCP operations| MC
    MC -->|Manages MCP protocol| PROTO
    CP -->|Read current file| ED
    CP -->|Get settings| CFG
    
    %% MCP Protocol Communication
    PROTO -->|JSON-RPC 2.0 calls| SERVER
    SERVER -->|MCP responses| PROTO
    
    %% Server Processing
    SERVER -->|Handle tools| TOOLS
    SERVER -->|Handle resources| RESOURCES
    SERVER -->|AI enhancement| AI
    
    %% AI Enhancement
    AI -->|Generate embeddings| EMB
    EMB -->|Vector operations| VEC
    AI -->|Build context| CONTEXT
    
    %% Local Data Access
    SERVER -->|Cache access| CACHE
    SERVER -->|Index queries| INDEX
    SERVER -->|Read config| CONFIG
    SERVER -->|Log operations| LOGS
    
    %% Remote Service Integration
    SERVER -->|API calls| BB_API
    BB_API -->|Workspace data| WS
    BB_API -->|Repository data| REPOS
    BB_API -->|File content| FILES
    BB_API -->|Search operations| SEARCH_API
    
    %% External Services
    SERVER -->|Authentication| AUTH
    SERVER -->|Webhook handling| WEBHOOK
    
    %% Data Flow Back
    CACHE -->|Cached data| SERVER
    INDEX -->|Indexed results| AI
    WS -->|Workspace info| SERVER
    REPOS -->|Repository structure| RESOURCES
    FILES -->|Source code| TOOLS
    SEARCH_API -->|Search results| CONTEXT
    
    %% Styling
    classDef hostLayer fill:#e3f2fd
    classDef clientLayer fill:#f3e5f5
    classDef protocolLayer fill:#fce4ec
    classDef serverLayer fill:#e8f5e8
    classDef localDataLayer fill:#fff8e1
    classDef remoteServiceLayer fill:#fff3e0
    
    class HOST,GC,LM,ED,CFG,UI hostLayer
    class CP,BCP,MC clientLayer
    class PROTO protocolLayer
    class SERVER,TOOLS,RESOURCES,AI,EMB,VEC,CONTEXT serverLayer
    class CACHE,INDEX,CONFIG,LOGS localDataLayer
    class BB_API,WS,REPOS,FILES,SEARCH_API,AUTH,WEBHOOK remoteServiceLayer